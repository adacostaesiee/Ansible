---
- hosts: [dbservers]
  become: true

  handlers:
    - name: "Restart mysql service"
      service:
        name: mysql
        state: restarted

  tasks:
    - name: "Install MariaDB Client 10.3, MariaDB Server 10.3 and MySQL-Python"
      apt:
        name:
          - mariadb-server
          - mariadb-client
          - python3-pymysql
          - mysql-client-core-8.0
        state: latest

    - name: "Create MariaDB Directories"
      file:
        path: /data/MariaDB
        state: directory
        owner: mysql
        group: mysql
        recurse: yes
      with_items:
        - db
        - log

    - name: "Count files in /data/d b"
      find:
        path: /data/db
        patterns: '\*'
      register: db_files

    - name: "Run mysql_install_db only if /data/db is empty"
      command: mysql_install_db --datadir=/data/db
      when: db_files.matched|int == 0

    - name: "Create user with password, all database privileges and 'WITH GRANT OPTION' in db1 and db2"
      community.mysql.mysql_user:
        check_implicit_admin: yes
        login_user: root
        login_password: "{{ mysql_root_password }}"
        state: present
        name: glpi
        password: "{{ mysql_glpi_password }}"
        host: "%"
        priv:
          'glpi.*': 'ALL,GRANT'

    - name: "Push MariaDB config file to dbserver master"
      template:
        src: "{{ item }}"
        dest: /etc/mysql/mariadb.conf.d/{{ item | basename | regex_replace('\.j2$', '') }}
      with_fileglob:
        - files/50-server.cnf.j2
      notify: Restart mysql service
      when: mysql_server_id==1

    - name: "Push MariaDB config file to dbserver slave"
      template:
        src: "{{ item }}"
        dest: /etc/mysql/mariadb.conf.d/{{ item | basename | regex_replace('\.j2$', '.cnf') }}
      with_fileglob:
        - files/50-server.j2
      notify: Restart mysql service
      tags: conf
      when: mysql_server_id==2

    - name: "Create backup directory"
      file:
        path: "/etc/backups/"
        state: directory
      when: mysql_server_id==2

    - name: "Push backup script"
      template:
        src: "{{ item }}"
        dest: /etc/backups/{{ item | basename | regex_replace('\.j2$', '') }}.sh
      with_fileglob:
        - files/backupsql.j2
      when: mysql_server_id==2

    - name: Creates weekly backup cronjob
      cron:
        minute: "25"
        hour: "15"
        weekday: "*"
        name: "Backup mysql GLPI DB"
        cron_file: "glpidailybackups.daily"
        user: "root"
        job: '/etc/backups/backupsql.sh'
      when: mysql_server_id==2

    - name: "Change backup script rights"
      shell: 'chmod +x /etc/backups/backupsql.sh'
      when: mysql_server_id==2